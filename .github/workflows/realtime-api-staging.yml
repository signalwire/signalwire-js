name: RealtimeAPI SDK [staging]

on:
  push:
    branches:
      - 'min/run-only-video-test'
  workflow_call:
  workflow_dispatch:
  schedule:
    - cron: '30 */2 * * *'

concurrency:
  group: ${{ github.workflow }}-realtime-api-staging-${{ github.ref }}
  cancel-in-progress: true

jobs:
  e2e-tests:
    name: Run E2E tests
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false # Continue other jobs if one fails
      matrix:
        node-version: [18.x]
        # test_command: ['dev:rtonly', 'dev:playwright']
        test_command: ['dev:playwright']
    steps:
      - uses: actions/checkout@v4
      - name: Install deps
        uses: ./.github/actions/install
        with:
          NODE_VERSION: ${{ matrix.node-version }}
      - name: Build SDKs
        uses: ./.github/actions/build
        with:
          NODE_VERSION: ${{ matrix.node-version }}
      - name: Install Playwright
        if: matrix.test_command == 'dev:playwright'
        uses: ./.github/actions/playwright
        with:
          PLAYWRIGHT_VERSION: '1.35.1'
      - name: Test
        run: 'npm run -w=@sw-internal/e2e-realtime-api ${{ matrix.test_command }}'
        env:
          SW_TEST_CONFIG: |
            {
              "ignoreFiles": [
                "chat.test.ts",
                "messaging.test.ts",
                "pubSub.test.ts",
                "task.test.ts",
                "utils.test.ts",
                "voice.test.ts",
                "voicePass.test.ts",
                "voiceTapAllListeners.test.ts",
                "playwright/videoHandRaise.test.ts"
              ],
              "env": {
                "API_HOST": "dev.swire.io",
                "RELAY_HOST": "relay.swire.io",
                "RELAY_PROJECT": "78429ef1-283b-4fa9-8ebc-16b59f95bb1f",
                "RELAY_TOKEN": "${{ fromJSON(secrets.STAGING_E2E_REALTIME_SW_TEST_CONFIG).env.RELAY_TOKEN }}",
                "MESSAGING_FROM_NUMBER": "+10000000000",
                "MESSAGING_TO_NUMBER": "+10000000001",
                "MESSAGING_CONTEXT": "messaging-e2e",
                "DAPP_DOMAIN": "dapp.swire.io",
                "PLAYBACK_URL": "http://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4"
              }
            }

  report-result:
    needs: e2e-tests
    runs-on: ubuntu-latest
    if: success() || failure()
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/report-test-result
        with:
          result: ${{ needs.e2e-tests.result }}
          test-suite: realtime-api
          environment: staging
          influxdb-bucket: ${{ secrets.INFLUXDB_BUCKET }}
          influxdb-org: ${{ secrets.INFLUXDB_ORG }}
          influxdb-token: ${{ secrets.INFLUXDB_TOKEN }}
          influxdb-url: ${{ secrets.INFLUXDB_URL }}
